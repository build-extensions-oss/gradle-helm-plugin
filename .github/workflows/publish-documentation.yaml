name: Plugin documentation

# This workflow is strictly manual
# https://docs.github.com/en/actions/using-workflows/manually-running-a-workflow
# It shouldn't be merged with plugin publication to keep an ability of independent documentation update
on:
  # allow manual runs
  workflow_dispatch:
  # run automatically on publish
  release:
    types: [ published ]

# We deploy into the *account pages* repository (<owner>.github.io), so we do not use the GitHub Pages
# artifact/deploy APIs here. Deployment happens via a git push into the account pages repo.
permissions:
  contents: read

jobs:
  gradle:
    runs-on: ubuntu-latest

    environment:
      # This job must only run in Publishing environment. It is protected from the majority of runs, which prevents Gradle secrets leakage
      name: Publishing
      url: https://github.com/build-extensions-oss/gradle-helm-plugin/settings/environments/10298625189/edit

    env:
      # Target repo that backs the GitHub *account* pages site:
      #   https://<owner>.github.io/
      ACCOUNT_PAGES_REPO: ${{ github.repository_owner }}/${{ github.repository_owner }}.github.io
      # Deploy under a prefix so the docs are served at:
      #   https://<owner>.github.io/<this-repository>/
      DEPLOY_PREFIX: ${{ github.event.repository.name }}

    steps:
      # https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-java-with-gradle#using-the-gradle-starter-workflow
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: Checkout Repo
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      # https://github.com/marketplace/actions/build-with-gradle
      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@4d9f0ba0025fe599b4ebab900eb7f3a1d93ef4c2 # v5

      # https://github.com/marketplace/actions/gradle-wrapper-validation
      - name: Validate Gradle wrapper
        uses: gradle/wrapper-validation-action@f9c9c575b8b21b6485636a91ffecd10e558c62f6 # v3.5.0

      # https://github.com/marketplace/actions/gradle-build-action
      - name: Build with Gradle
        uses: gradle/gradle-build-action@ac2d340dc04d9e1113182899e983b5400c17cda1 # v3.5.0
        with:
          arguments: asciidoctor

      # Retrieve the latest official release. That guarantees that we always put the proper version into documentation
      # Please note the parameter "-Pversion=${{ steps.latest_release.outputs.tag }}" below
      # See also https://cli.github.com/manual/gh_api
      - name: Get latest release via gh
        id: latest_release
        shell: bash
        env:
          # otherwise it will fail with: 'gh: To use GitHub CLI in a GitHub Actions workflow, set the GH_TOKEN environment variable.'
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          echo "tag=$(gh release list --exclude-drafts --exclude-pre-releases --limit 1 --json tagName --jq '.[0].tagName')" >> "$GITHUB_OUTPUT"
          echo "name=$(gh release list --exclude-drafts --exclude-pre-releases --limit 1 --json name --jq '.[0].name')" >> "$GITHUB_OUTPUT"

      - name: Generate documentation
        # run askiidoctor command, however assign more operating memory: we have it on VM, so why not using it?
        run: ./gradlew asciidoctor "-Pversion=${{ steps.latest_release.outputs.tag }}" "-Porg.gradle.jvmargs=-Xmx4G -XX:MaxMetaspaceSize=2G" --no-daemon --info --stacktrace

      # Checkout the <owner>.github.io repository and publish docs into a subfolder named after this repository
      - name: Checkout account pages repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          repository: ${{ env.ACCOUNT_PAGES_REPO }}
          path: account-pages
          # REQUIRED: a PAT with write access to <owner>.github.io (GITHUB_TOKEN cannot push to a different repo)
          # is defined here: https://github.com/build-extensions-oss/gradle-helm-plugin/settings/environments/10298625189/edit
          token: ${{ secrets.ACCOUNT_PAGES_TOKEN }}

      - name: Publish docs into account pages with repository prefix
        shell: bash
        run: |
          set -euo pipefail

          SRC_DIR="./build/docs/asciidoc/"
          DEST_ROOT="./account-pages"
          DEST_DIR="${DEST_ROOT}/${DEPLOY_PREFIX}"

          # Ensure GitHub Pages serves raw files (no Jekyll processing).
          touch "${DEST_ROOT}/.nojekyll"

          mkdir -p "${DEST_DIR}"
          rsync -av --delete "${SRC_DIR}" "${DEST_DIR}/"

      - name: Commit and push
        shell: bash
        run: |
          set -euo pipefail

          cd account-pages
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add -A
          if git diff --cached --quiet; then
            echo "No changes to deploy."
            exit 0
          fi

          git commit -m "Deploy ${DEPLOY_PREFIX} docs from ${GITHUB_REPOSITORY}@${GITHUB_SHA}"
          git push