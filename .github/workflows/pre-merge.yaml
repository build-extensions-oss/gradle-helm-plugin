name: Pre Merge Checks

on:
  push:
    branches:
      - "master"      # run on master branch only - no need to start the job automatically otherwise
  pull_request:
    branches:
      - "**"      # run on PRs targeting ANY branch (assuming we check the Gradle wrapper first)
  workflow_dispatch:

permissions:
  contents: read

jobs:
  # this job only compiled code and runs unit tests. It doesn't run functional tests.
  build:
    runs-on: ubuntu-latest
    steps:
      # https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-java-with-gradle#using-the-gradle-starter-workflow
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: Checkout Repo
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      # Protect from putting custom jar as a gradle wrapper
      # https://github.com/gradle/actions/tree/main/wrapper-validation
      - name: Validate Gradle wrapper
        uses: gradle/actions/wrapper-validation@4d9f0ba0025fe599b4ebab900eb7f3a1d93ef4c2 # v5

      # setup JDK - depending on version selected
      # https://github.com/marketplace/actions/setup-java-jdk
      - name: Set up JDK
        uses: actions/setup-java@f2beeb24e141e01a676f977032f5a29d81c9e27e # v5.1.0
        with:
          # Java 17 is baseline for our project. So, code must be compiled under it
          java-version: 17
          distribution: 'temurin'

      # Optimize Gradle execution
      # https://github.com/marketplace/actions/build-with-gradle
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@4d9f0ba0025fe599b4ebab900eb7f3a1d93ef4c2 # v5

      # Build the project by simply running the command line
      # No need to use daemon (this is run once container), however we print detailed logs and stacktrace
      - name: Assemble the project
        # Notes:
        # All important internal tasks a linked to build.
        # Add more memory for Gradle and compiler. See also https://github.com/build-extensions-oss/gradle-helm-plugin/issues/26
        # Keep Kotlin compiler running as a daemon - otherwise the configuration will be complex
        # We just publish plugin here - deep tests will be executed at later stages
        run: |
          ./gradlew \
          publishAllPublicationsToLocalRepoRepository \
          "-Porg.gradle.jvmargs=-Xmx1G -XX:MaxMetaspaceSize=2G" \
          --stacktrace \
          --info \
          --no-daemon

      - name: Upload plugin files
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        with:
          name: build-output
          if-no-files-found: error
          path: ./build/local-repo/**

  functional-test:
    name: Functional tests (${{ matrix.os }}, Java ${{ matrix.java }})
    needs: build
    runs-on: ${{ matrix.os }}

    # run test on multiple operating systems
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        java: ["17", "21"]

    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Set up Java ${{ matrix.java }}
        uses: actions/setup-java@f2beeb24e141e01a676f977032f5a29d81c9e27e # v5
        with:
          distribution: temurin
          java-version: ${{ matrix.java }}

      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@4d9f0ba0025fe599b4ebab900eb7f3a1d93ef4c2 # v5

      - name: Download build outputs
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7
        with:
          name: build-output
          path: ./build/local-repo/

      # Key requirement: do NOT recompile during tests, but run functional tests.
      - name: Functional tests (no recompilation)
        # workaround for Windows
        shell: bash
        run: |
          ./gradlew \
            --no-daemon \
            --stacktrace \
            "-Porg.gradle.jvmargs=-Xmx1G -XX:MaxMetaspaceSize=2G" \
            "-Pio.github.build.extensions.oss.gradle.helm.plugin.functional.tests.only=true" \
            functionalTest \
            copyFunctionalTestCoverage

      - name: Upload Kover execution data
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        with:
          # Must be unique per job (artifact v4 immutability)
          name: kover-functional-tests-${{ matrix.os }}-java${{ matrix.java }}
          if-no-files-found: error
          path: ./build/tmp/collected/kover-bin-reports/*.ic

  coverage:
    name: Coverage (merge OS runs, upload to Codecov)
    needs: functional-test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Set up Java 17
        uses: actions/setup-java@f2beeb24e141e01a676f977032f5a29d81c9e27e # v5
        with:
          distribution: temurin
          java-version: "17"

      - name: Download Kover functional tests artifacts
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7
        with:
          pattern: kover-functional-tests-*
          path: ./build/tmp/kover-artifacts/functional-tests
          # see https://github.com/actions/download-artifact
          # this instructs the build action to download each artifact to different folder.
          # Folder should be like:
          # ./build/tmp/kover-artifacts/functional-tests/kover-functional-tests-windows-latest-java17/
          # Alternatively all files will be overridden by the either first or last artifact.
          merge-multiple: false

      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@4d9f0ba0025fe599b4ebab900eb7f3a1d93ef4c2 # v5

      # Merge XML reports - and exclude functional tests (they must be executed on other platforms)
      - name: Merge Kover reports
        run: ./gradlew build koverXmlReport validateExternalKoverArtifacts -x functionalTest "-Porg.gradle.jvmargs=-Xmx1G -XX:MaxMetaspaceSize=2G" --no-daemon --info --stacktrace

      # see https://app.codecov.io/github/build-extensions-oss
      - name: Upload coverage reports to Codecov
        uses: codecov/codecov-action@671740ac38dd9b0130fbe1cec585b89eea48d3de # v5
        with:
          files: ./build/reports/kover/report.xml
          verbose: true
          token: ${{ secrets.CODECOV_TOKEN }}